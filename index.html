<!DOCTYPE html>
<html>
<head>
    <title>Popular Beers</title>
    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!-- Chartist -->
    <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <style>
        #beer-logo-bud{
            background: url(budlight.jpg);
        }
        #beer-logo-coors{
            background: url(coors.png);
        }
        #beer-logo-genny{
            background: url(genny.jpg);
        }
        #beer-logo-bud,#beer-logo-coors,#beer-logo-genny{
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: CONTAIN;
            background-position: CENTER CENTER;
            background-repeat: NO-REPEAT;
            height: 10em;
        }
        a{
            cursor:pointer;
        }
        .col-sm-4:hover{
            border:1px solid #333;
        }
        #zoneName{
            margin-bottom: 2em;
        }
        h1{
            background: black;
            color: white;
            padding: .25em;
            text-align: center;
        }
    </style>
</head>

<body>

<div class="container">

    <!-- Title -->
    <h1>
        Beer Popularity Among Wegmans
    </h1>

    <!-- Input -->
    <h3>
        Pick a city:
    </h3>
    <input type="text" id="zoneName" name="zoneName" value="">

    <h3>
        Choose a beer:
    </h3>
    <!-- Beer Buttons -->
    <div class="row">
        <a onclick="run(112985)"><div class="col-sm-4" id="beer-logo-bud"></div></a>
        <a onclick="run(90188)"><div class="col-sm-4" id="beer-logo-coors"></div></a>
        <a onclick="run(237942)"><div class="col-sm-4" id="beer-logo-genny"></div></a>
    </div>

    <!-- Chart -->
    <div class="ct-chart ct-square"></div>

</div>

<script type="text/javascript">

    //create some important vars
    var chart;
    var authKey = "Bearer ";
    var subKey = "7a2da79699e74dd0af5b8158f6134fbd";

    $( document ).ready(function() {

        //get keys for weggies api
        var settings = {
          "async": true,
          "crossDomain": true,
          "url": "https://login.microsoftonline.com/1318d57f-757b-45b3-b1b0-9b3c3842774f/oauth2/token",
          "method": "POST",
          "headers": {
            "Content-Type": "application/x-www-form-urlencoded",
            "Cache-Control": "no-cache"
          },
          "data": {
            "client_id": "24960d97-4fbe-433d-ab8a-efeb89aa524e",
            "grant_type": "client_credentials",
            "resource": "https://wegmans-es.azure-api.net",
            "client_secret": "A8N7VeeCdFD5N4OxeQT1gFaXNStrxieEplYl3SYdxTs="
          }
        };

        $.ajax(settings).done(function (response) {
          authKey += response.access_token;
          console.log(authKey);
        });
      });

      //attach 'enter' key to button
      $("#zoneName").keyup(function(event) {
        if (event.keyCode === 13) {
          $("#submit").click();
        }
    });

    var BeerVelocities = [ [], [], [] ]; // Score for each beer type
    var StoreNames = []; // The names of stores seen
    var beerSkus = []; // The Skus of beers seen


    function run(beerID){
        var zoneName = document.getElementById("zoneName").value;
        //console.log(zoneName);

        if( !beerSkus.includes(beerID)) {
            beerSkus.push(beerID);
            //console.log("BEER SKUS: " + beerSkus.length);

            var promise = $.ajax({
                url: "https://wegmans-es.azure-api.net/locationpublic/location/stores?zoneName=" + zoneName,
                //url: "https://wegmans-es.azure-api.net/productpublic/productavailability/700632/stores",
                beforeSend: setHeaders,
                type: "GET",
                // Request body
                data: "{body}"
            })
            .done(function(data) {
              for(i = 0; i < data.length; i++) {
                  console.log(data[i].Name);

                  if(!StoreNames.includes(data[i].Name)) StoreNames.push(data[i].Name); //adds store names
                  getAvailabilityAtStore(data[i].StoreNumber, beerID);
              }
            })
            .fail(function() {
              console.log("error");
            });
        }

        console.log(BeerVelocities);
        console.log(StoreNames);


//        graphResults(BeerVelocities);

    }

/*    function graphResults(velocities) {

        var keys = [];

        for (var key in velocities) {
            console.log(key);
            keys.Add(key);
        }
        new Chartist.Bar('.ct-chart', {
          labels: StoreNames
          series: [
            [5, 4, 3, 7, 5, 10, 3],
            [3, 2, 9, 5, 4, 6, 4]
          ]
        }, {
          seriesBarDistance: 10,
          reverseData: true,
          horizontalBars: true,
          axisY: {
            offset: 70
          }
        });


    }*/

    function getAvailabilityAtStore(storeNum,beerID) {
            $.ajax({
                url: "https://wegmans-es.azure-api.net/productpublic/productavailability/" + beerID + "/" + storeNum,
                //url: "https://wegmans-es.azure-api.net/productpublic/productavailability/700632/stores",
                beforeSend: setHeaders,
                type: "GET",
                // Request body
                data: "{body}"
              })
                .done(function(availability) {
                    //console.log("availability");
                    BeerVelocities[beerSkus.length - 1].push(availability[0].Velocity);
                    var event = new Event('DOMContentLoaded');
                    document.dispatchEvent(event);
                    //console.log(BeerVelocities);

                })
                .fail(function() {
                  console.log("error");
                });

    }

    function setHeaders(xhrObj) {
        xhrObj.setRequestHeader("Location-Subscription-Key", subKey);
        xhrObj.setRequestHeader("Product-Subscription-Key",subKey);
        xhrObj.setRequestHeader("Authorization",authKey);
        xhrObj.setRequestHeader("Availability-Subscription-Key", subKey);
    }

    document.addEventListener('DOMContentLoaded',function(){
      //console.log(StoreNames);
      console.log(BeerVelocities);

      chart = new Chartist.Bar('.ct-chart', {
        labels: StoreNames,
        series: [
          BeerVelocities[0],
          BeerVelocities[1],
          BeerVelocities[2]
        ]
      }, {
        seriesBarDistance: 10,
        reverseData: true,
        horizontalBars: true,
        axisY: {
          offset: 70
        }
      });
    });


</script>
[1, 1, 1, 1, 1, 10, 3],[1, 1, 1, 1, 1, 1, 1]
</body>
</html>

