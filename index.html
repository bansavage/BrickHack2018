<!DOCTYPE html>
<html>
<head>
    <title>JSSample</title>
    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</head>

<body>

<div class="container">
    <h1>
        Wegmans API Hackin'
    </h1>
    City Name
    <br>
    <input type="text" id="zoneName" name="zoneName" value="">
    <br>
    <button id="submit" type="button" onclick="run()">Click Me!</button>
</div>


<script type="text/javascript">

    var authKey = "Bearer ";
    var subKey = "7a2da79699e74dd0af5b8158f6134fbd";


      //GET KEYS
      $( document ).ready(function() {
        var settings = {
          "async": true,
          "crossDomain": true,
          "url": "https://login.microsoftonline.com/1318d57f-757b-45b3-b1b0-9b3c3842774f/oauth2/token",
          "method": "POST",
          "headers": {
            "Content-Type": "application/x-www-form-urlencoded",
            "Cache-Control": "no-cache"
          },
          "data": {
            "client_id": "24960d97-4fbe-433d-ab8a-efeb89aa524e",
            "grant_type": "client_credentials",
            "resource": "https://wegmans-es.azure-api.net",
            "client_secret": "A8N7VeeCdFD5N4OxeQT1gFaXNStrxieEplYl3SYdxTs="
          }
        };

        $.ajax(settings).done(function (response) {
          authKey += response.access_token;
          console.log(authKey);
        });
      });

      //attach 'enter' key to button
      $("#zoneName").keyup(function(event) {
        if (event.keyCode === 13) {
          $("#submit").click();
        }
      });

    var BeerVelocities = {};

    function run(){
        var zoneName = document.getElementById("zoneName").value;
        console.log(zoneName);


        var promise = $.ajax({
            url: "https://wegmans-es.azure-api.net/locationpublic/location/stores?zoneName=" + zoneName,
            //url: "https://wegmans-es.azure-api.net/productpublic/productavailability/700632/stores",
            beforeSend: setHeaders,
            type: "GET",
            // Request body
            data: "{body}"
        })
        .done(function(data) {
          /*for(var name in data) {
              console.log(name);
          }*/

          for(i = 0; i < data.length; i++) {
              console.log(data[i].Name);

              getAvailabilityAtStore(data[i].StoreNumber);
          }


        })
        .fail(function() {
          console.log("error");
        });

        //console.log("Num Entries: " + Object.keys(BeerVelocities).length.toString());
        console.log(BeerVelocities);
    }

    var beerSkus = [ 112985 , 90188, 237942 ]; // Bud light, Genesse, Coors


    function getAvailabilityAtStore(storeNum) {
     //console.log(storeNum + ", ");
        for(b = 0; b < beerSkus.length; b++) {
            //console.log(beerSkus[b]);

            $.ajax({
                url: "https://wegmans-es.azure-api.net/productpublic/productavailability/" + beerSkus[b] + "/" + storeNum,
                //url: "https://wegmans-es.azure-api.net/productpublic/productavailability/700632/stores",
                beforeSend: setHeaders,
                type: "GET",
                // Request body
                data: "{body}"
              })
                .done(function(availability) {
                    BeerVelocities[
                        storeNum.toString()+ "-" + availability[0].Sku.toString()
                    ] = availability[0].Velocity;

                    //console.log(" At store " + storeNum + " sku:" + availability[0].Sku + " has velocity of: " + availability[0].Velocity);
                    //console.log(BeerVelocities);

                })
                .fail(function() {
                  console.log("error");
                });


       }

    }

    function setHeaders(xhrObj) {
        xhrObj.setRequestHeader("Location-Subscription-Key", subKey);
        xhrObj.setRequestHeader("Product-Subscription-Key",subKey);
        xhrObj.setRequestHeader("Authorization",authKey);
        xhrObj.setRequestHeader("Availability-Subscription-Key", subKey);
    }


</script>

</body>
</html>
